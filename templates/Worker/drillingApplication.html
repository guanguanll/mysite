{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>打孔申请</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="{% static 'layuiadmin/layui/css/layui.css' %}">
    <link rel="stylesheet" href="{% static 'layuiadmin/style/admin.css' %}">
</head>
<style>
    .layui-panel .layui-input {
        height: 38px;
        line-height: 1.3;
        line-height: 38px \9;
        border-width: 1px;
        border-style: solid;
        background-color: inherit;
        border: 0;
        border-radius: 2px;
    }
</style>
<body layadmin-themealias="default">
<div class="layui-fluid">
    <div class="layui-card">
        <div class="layui-card-body">
            <blockquote class="layui-elem-quote">打孔申请</blockquote>
            <form class="layui-form" action="">
                <div class="layui-bg-gray" style="padding: 30px;">
                    <div class="layui-row layui-col-space15">
                        <div class="layui-inline">
                            <div class="layui-form-item">
                                <label class="layui-form-label">工作面选择</label>
                                <div class="layui-input-block">
                                    <select name="work_face" lay-verify="required" id="work_face"
                                            lay-filter="work_face">
                                        <option value=""></option>
                                        {% for item in work_face %}
                                            <option value="{{ item.0 }}">{{ item.1 }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-form-item">
                                <label class="layui-form-label">巷道选择</label>
                                <div class="layui-input-block">
                                    <select name="tunnel" id="tunnel" lay-verify="required" lay-filter="tunnel">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-form-item">
                                <label class="layui-form-label">排号选择</label>
                                <div class="layui-input-block">
                                    <select name="row" lay-verify="required" id="row" lay-filter="row">
                                        <option value=""></option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="layui-panel" style="display:none">
                            <div style="padding: 20px 20px;">
                                <table class="layui-table">
                                    <th colspan="6" style="background-color:#c0c4cc;align:center"><b>设计孔信息</b></th>
                                    <tr>

                                        <td>
                                            <label class="layui-form-label">孔号</label>
                                        </td>
                                        <td>
                                            <div class="layui-input-inline">
                                                <div class="layui-form-item">
                                                    <input type="text" id="hole_number" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <label class="layui-form-label">偏角</label>
                                        </td>
                                        <td>
                                            <div class="layui-form-item">
                                                <input type="text" id="deflection_angle" required
                                                       lay-verify="required"
                                                       placeholder="null" autocomplete="off" class="layui-input"
                                                       disabled>
                                            </div>
                                        </td>
                                        <td>
                                            <label class="layui-form-label">仰角</label>
                                        </td>
                                        <td>
                                            <div class="layui-form-item">
                                                <input type="text" id="design_elevation_angel" required
                                                       lay-verify="required"
                                                       placeholder="null" autocomplete="off" class="layui-input"
                                                       disabled>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr>
                                        <div class="layui-input-inline">
                                            <td><label class="layui-form-label">孔深</label>
                                            </td>
                                            <td>
                                                <div class="layui-form-item">
                                                    <input type="text" id="hole_depth" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </td>
                                            <td><label class="layui-form-label">岩孔长度</label>
                                            </td>
                                            <td>
                                                <div class="layui-form-item">
                                                    <input type="text" id="rock_section" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </td>
                                            <td>
                                                <label class="layui-form-label">煤段长度</label>
                                            </td>
                                            <td>
                                                <div class="layui-form-item">
                                                    <input type="text" id="coal_section" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </td>
                                        </div>
                                    </tr>
                                    <tr>
                                        <div class="layui-input-inline">
                                            <td>
                                                <label class="layui-form-label">冲煤量</label>
                                            </td>
                                            <td colspan="5">
                                                <div class="layui-form-item">
                                                    <input type="text" id="weight_of_flush_coal" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </td>

                                        </div>
                                    </tr>
                                    <tr>

                                        <div class="layui-input-inline">
                                            <td>
                                                <label class="layui-form-label">见顶提醒</label>
                                            </td>
                                            <td colspan="5">
                                                <div class="layui-form-item" style="width: 60%">
                                                    <input type="text" id="see_ding_tip" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </td>

                                        </div>
                                    </tr>
                                    <tr>
                                        <div class="layui-input-inline">
                                            <td>
                                                <label class="layui-form-label">见煤提醒</label>

                                            </td>
                                            <td colspan="5">
                                                <div class="layui-form-item" style="width: 60%">
                                                    <input type="text" id="see_mei_tip" required
                                                           lay-verify="required"
                                                           placeholder="null" autocomplete="off" class="layui-input"
                                                           disabled>
                                                </div>
                                            </td>
                                        </div>
                                    </tr>
                                </table>
                            </div>
                            <div class="layui-form-item">
                                <div class="layui-input-block">
                                    <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1"
                                            style="float:right;margin-right:50%">提交打孔申请
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
</body>
</html>

<script src="{% static 'js/jquery-1.11.1.min.js' %}"></script>
<script src="{% static 'layuiadmin/layui/layui.js' %}"></script>

<script>
    layui.use(['table', 'upload', 'layer', 'form'], function () {
        var table = layui.table;
        var layer = layui.layer;
        var $ = layui.$;
        var form = layui.form;

        //工作面选择
        form.on('select(work_face)', function (data) {
            var work_face = $("#work_face").val();
            console.log("选择工作面" + work_face);
            $.post(
                {% url 'getTunnelByWorkface' %},
                {"work_face": work_face},
                function (data) {
                    //每次先清空下拉框
                    $("#tunnel").empty();
                    $("#row").empty();
                    //先给一个空选项
                    $("#tunnel").append($("<option />").text("").attr("value", ""));
                    console.log("data is " + data.data, JSON.stringify(data.data));
                    {#console.log(JSON.parse(data.data))#}
                    tunnelObjs = JSON.stringify(data.data) !== '{}' ? JSON.parse(data.data) : [];
                    console.log(tunnelObjs, 'tunnelObjs')
                    tunnelObjs.map((item, index) => {
                        id = item.pk;
                        name = item.fields.tunnel_name;
                        $("#tunnel").append($("<option />").text(name).attr("value", id)); //动态添加标签
                        return item;
                    });
                    form.render();
                })
        });

        //巷道选择
        form.on('select(tunnel)', function (data) {
            var tunnel = $("#tunnel").val();
            console.log("选择巷道" + tunnel);
            $.post(
                {% url 'getRowByTunnel' %},
                {"tunnel": tunnel},
                function (data) {
                    //每次先清空下拉框
                    $("#row").empty();
                    $("#row").append($("<option />").text("").attr("value", ""));
                    console.log("data is " + data.data, JSON.stringify(data.data));
                    {#console.log(JSON.parse(data.data))#}
                    rowObjs = JSON.stringify(data.data) !== '{}' ? JSON.parse(data.data) : [];
                    console.log(rowObjs, 'rowObjs')
                    rowObjs.map((item, index) => {
                        id = item.pk;
                        name = item.fields.row_id;
                        $("#row").append($("<option />").text(name).attr("value", id)); //动态添加标签
                        return item;
                    });
                    form.render();
                })
        });

        //排号选择后，刷新界面
        form.on('select(row)', function (data) {
            var row = $("#row").val();
            console.log("选择排号" + row);
            $.post(
                {% url 'getHoleDesignData' %},
                {"row": row},
                function (data) {
                    console.log(JSON.stringify(data));
                    if (data.code === 0) {
                        $("#hole_number").val(data.hole_number);
                        $("#deflection_angle").val(data.deflection_angle);
                        $("#design_elevation_angel").val(data.design_elevation_angel);
                        $("#hole_depth").val(data.hole_depth);
                        $("#rock_section").val(data.rock_section);
                        $("#coal_section").val(data.coal_section);
                        $("#weight_of_flush_coal").val(data.weight_of_flush_coal);
                        $("#see_ceil").val(data.see_ceil);
                        $("#see_ding_tip").val("预计" + data.see_ceil + "米见岩，请缓慢钻进并注意见顶辨识");
                        $("#see_mei_tip").val("预计" + data.rock_section + "米见煤，请缓慢钻进并注意见煤辨识");
                        $(".layui-panel").show();
                    } else {
                        layer.msg('查询当前排未申请打孔的记录为空', {icon: 2});
                    }
                    form.render();
                })
        });
        //监听提交
        form.on('submit(demo1)', function (data) {
            var hole_number = $("#hole_number").val();
            var deflection_angle = $("#deflection_angle").val();
            var design_elevation_angel = $("#design_elevation_angel").val();
            var hole_depth = $("#hole_depth").val();
            var rock_section = $("#rock_section").val();
            var coal_section = $("#coal_section").val();
            var weight_of_flush_coal = $("#weight_of_flush_coal").val();
            var see_ceil = $("#see_ceil").val();
            var work_face = data.field.work_face;
            var tunnel = data.field.tunnel;
            var row = data.field.row;
            console.log("hole_number:", hole_number);
            console.log("deflection_angle:", deflection_angle);
            console.log("design_elevation_angel:", design_elevation_angel);
            console.log("hole_depth:", hole_depth);
            console.log("rock_section:", rock_section);
            console.log("coal_section:", coal_section);
            console.log("weight_of_flush_coal:", weight_of_flush_coal);
            console.log("see_ceil:", see_ceil);
            console.log("work_face:", work_face);
            console.log("tunnel:", tunnel);
            console.log("row:", row);
            datas = {
                "hole_number": hole_number,
                "deflection_angle": deflection_angle,
                "design_elevation_angel": design_elevation_angel,
                "hole_depth": hole_depth,
                "rock_section": rock_section,
                "coal_section": coal_section,
                "weight_of_flush_coal": weight_of_flush_coal,
                "see_ceil": see_ceil,
                "work_face": work_face,
                "tunnel": tunnel,
                "row": row
            }
            $.post(
                {% url 'drill_apply_record_page' %},
                {"data": JSON.stringify(datas)},
                function (response) {
                    console.log("接口返回", response);
                    layer.msg("提交成功", {icon: 1});
                    $(".layui-panel").hide();
                    $("#work_face").empty();
                    $("#tunnel").empty();
                    $("#row").empty();
                    form.render();
                }
            );
            return false;
        });
    });
</script>
